"use strict";lab.directive("drawAction",function($window,utilities){function link(scope,element,attr){function buildHistogram(histoList,fitJSON){var dataList=[],layout={},yaxis={showgrid:!0};if(histoList.length>0){if("1D"===histoList[0].dimension){yaxis.title="Counts";for(var i=0;i<histoList.length;i++)dataList.push(histoList[i].data)}else{for(var data=histoList[0].data,text=[],row=0;row<data.z.length;row++){for(var rowText=[],col=0;col<data.z[row].length;col++){var t=void 0;t=null!=data.z[row][col]&&null!=data.errorZ[row][col]?data.z[row][col]+" &#177; "+data.errorZ[row][col]:"",rowText.push(t)}text.push(rowText)}yaxis.title=histoList[0].labelY+" ("+histoList[0].unitsY+")",data.text=text,data.hoverinfo="text",dataList.push(data)}if(layout={margin:{l:50,r:50,b:40,t:10,pad:4},xaxis:{title:histoList[0].labelX+" ("+histoList[0].unitsX+")",showgrid:!0},yaxis:yaxis,showlegend:!0},1===histoList.length&&"StackCounter"!==histoList[0].type){var annotations=void 0,nEntries={xref:"paper",yref:"paper",x:.94,y:.98,text:"N. entries: "+histoList[0].nentries,showarrow:!1,font:{family:"Arial",size:12,color:"#3c8dbc"}};if("1D"===histoList[0].dimension){annotations=[nEntries,{xref:"paper",yref:"paper",x:.94,y:.94,text:"Mean: "+histoList[0].mean[0].toExponential(3),showarrow:!1,font:{family:"Arial",size:12,color:"#3c8dbc"}},{xref:"paper",yref:"paper",x:.94,y:.9,text:"Std Dev: "+histoList[0].rms[0].toExponential(3),showarrow:!1,font:{family:"Arial",size:12,color:"#3c8dbc"}}]}if("2D"===histoList[0].dimension){annotations=[nEntries,{xref:"paper",yref:"paper",x:.94,y:.94,text:"Mean X: "+histoList[0].meanX[0].toExponential(3),showarrow:!1,font:{family:"Arial",size:12,color:"#3c8dbc"}},{xref:"paper",yref:"paper",x:.94,y:.9,text:"Mean Y: "+histoList[0].meanY[0].toExponential(3),showarrow:!1,font:{family:"Arial",size:12,color:"#3c8dbc"}},{xref:"paper",yref:"paper",x:.94,y:.86,text:"Std Dev X: "+histoList[0].stdDevX[0].toExponential(3),showarrow:!1,font:{family:"Arial",size:12,color:"#3c8dbc"}},{xref:"paper",yref:"paper",x:.94,y:.82,text:"Std Dev: "+histoList[0].stdDevY[0].toExponential(3),showarrow:!1,font:{family:"Arial",size:12,color:"#3c8dbc"}}]}layout.annotations=annotations}}else layout={margin:{l:50,r:50,b:40,t:120,pad:4},title:"No data selected",titlefont:{size:24,color:"#3c8dbc"}};if(void 0!==fitJSON&&null!==fitJSON&&null!==fitJSON&&!fitJSON.isError){var fitTotalTrace={x:fitJSON.totalPoints.x,y:fitJSON.totalPoints.y,name:"Fit function",mode:"lines",type:"scatter"};if(dataList.push(fitTotalTrace),null!=fitJSON.fitFunctions)for(var _i=0;_i<fitJSON.fitFunctions.length;_i++){var partialFit=fitJSON.fitFunctions[_i],fitPartialTrace={x:partialFit.x,y:partialFit.y,name:"#"+_i+" "+partialFit.fitFunction,mode:"lines",type:"scatter"};dataList.push(fitPartialTrace)}}return{dataList:dataList,layout:layout}}var width=100,height=100;void 0!==scope.width&&void 0!==scope.heigth&&(width=scope.width,height=scope.height);var gd=utilities.buildPlotly(element,width,height);scope.$watch("[drawhistolist, fit]",function(newValues,oldValues,scope){var histoList=newValues[0],fitJSON=newValues[1];if(void 0!==histoList){var histogram=buildHistogram(histoList,fitJSON);Plotly.newPlot(gd,histogram.dataList,histogram.layout)}},!0),window.onresize=function(){Plotly.Plots.resize(gd)}}return{link:link,restrict:"AE",scope:{drawhistolist:"=",fit:"=",width:"=",height:"="}}}),lab.directive("drawParticleCounter",function($window,utilities){function link(scope,element,attr){var width=90,height=100;void 0!==scope.width&&void 0!==scope.heigth&&(width=scope.width,height=scope.height);var gd=utilities.buildPlotly(element,width,height);scope.$watch("histogram",function(newHistogram,oldHistogram,scope){var dataList=newHistogram.data,layout=newHistogram.layout;Plotly.newPlot(gd,dataList,layout)},!0),window.onresize=function(){Plotly.Plots.resize(gd)}}return{link:link,restrict:"AE",scope:{histogram:"=",width:"=",height:"="}}}),lab.directive("drawPythia",function($window,utilities){function link(scope,element,attr){var width=100,height=100;void 0!==scope.width&&void 0!==scope.heigth&&(width=scope.width,height=scope.height);var gd=utilities.buildPlotly(element,width,height);scope.$watch("[histogram,fit]",function(newValues,oldValues,scope){var histogram=newValues[0],fitJSON=newValues[1];if(void 0!==histogram){var dataName=histogram.dataName,min=histogram.minX,max=histogram.maxX,nBins=histogram.nbins,y=histogram.data.y,dx=(max-min)/nBins,x=_.range(0,max+dx,dx),histogramData={x:x,y:y,type:"bar",name:dataName},dataList=[histogramData];if(void 0!==fitJSON&&null!=fitJSON&&!fitJSON.isError){var fitTotalTrace={x:fitJSON.totalPoints.x,y:fitJSON.totalPoints.y,name:"Fit function",mode:"lines",type:"scatter"};if(dataList.push(fitTotalTrace),null!=fitJSON.fitFunctions)for(var i=0;i<fitJSON.fitFunctions.length;i++){var partialFit=fitJSON.fitFunctions[i],fitPartialTrace={x:partialFit.x,y:partialFit.y,name:"#"+i+" "+partialFit.fitFunction,mode:"lines",type:"scatter"};dataList.push(fitPartialTrace)}}var titleX=dataName;"null"!==histogram.unitsX&&(titleX+=" ("+histogram.unitsX+")");var layout={margin:{l:50,r:50,b:40,t:40,pad:4},title:dataName+", particle: "+histogram.particleName,titlefont:{family:"Courier New, monospace",size:16,color:"#7f7f7f"},showlegend:!0,xaxis:{title:titleX},yaxis:{title:"Count"},bargap:.1,barmode:"stack"};Plotly.newPlot(gd,dataList,layout)}},!0),window.onresize=function(){Plotly.Plots.resize(gd)}}return{link:link,restrict:"AE",scope:{histogram:"=",fit:"=",width:"=",height:"="}}}),lab.directive("drawPythiaTree",function($window,$document){function link(scope,element,attr){function buildSVG(width,height){return d3.select($document[0].querySelector("#tree")).append("svg").attr("width",width).attr("height",height).append("g").attr("transform","translate("+margin.left+","+margin.top+")")}function drawTree(svg,eventjson){function getStatusLegend(statusRange){return statusRange>0&&statusRange<=10?statusRangeList[statusRange]:"Not defined"}function getStatusRange(status){var statusAbs=Math.abs(status);return statusAbs>=11&&statusAbs<=19?1:statusAbs>=21&&statusAbs<=29?2:statusAbs>=31&&statusAbs<=39?3:statusAbs>=41&&statusAbs<=49?4:statusAbs>=51&&statusAbs<=59?5:statusAbs>=61&&statusAbs<=69?6:statusAbs>=71&&statusAbs<=79?7:statusAbs>=81&&statusAbs<=89?8:statusAbs>=91&&statusAbs<=99?9:statusAbs>=101&&statusAbs<=109?10:1}function nodeInfo(node){return"<strong>N. event:</strong> "+node.nEvent+"<br /><strong>pdg:</strong> "+node.idParticle+"<br /><strong>status:</strong> "+node.status+", "+statusList[Math.abs(node.status)]+"<br /><strong>mothers: </strong>["+node.mothers[0]+", "+node.mothers[1]+"]<br /><strong>daughters: </strong>["+node.daughters[0]+", "+node.daughters[1]+"]<br /><strong>colour:</strong> "+node.colour+"<br /><strong>acolour:</strong> "+node.acolour+"<br /><strong>momentum (GeV/c):</strong> ["+node.p[0]+", "+node.p[1]+", "+node.p[2]+"]<br /><strong>energy (GeV):</strong> "+node.e+"<br /><strong>mass (GeV):</strong> "+node.m+"<br />"}function tick(){path.attr("d",function(d){var dx=d.target.x-d.source.x,dy=d.target.y-d.source.y,dr=Math.sqrt(dx*dx+dy*dy);return"M"+d.source.x+","+d.source.y+"A"+dr+","+dr+" 0 0,1 "+d.target.x+","+d.target.y}),node.attr("transform",function(d){return"translate("+d.x+","+d.y+")"})}var force=d3.layout.force().nodes(eventjson.nodes).links(eventjson.links).size([width,height]).linkDistance(50).charge(-60).on("tick",tick).start();svg.append("svg:defs").selectAll("marker").data(["end"]).enter().append("svg:marker").attr("id",String).attr("viewBox","0 -5 10 10").attr("refX",15).attr("refY",-1.5).attr("markerWidth",6).attr("markerHeight",6).attr("orient","auto").append("svg:path").attr("d","M0,-5L10,0L0,5");var colorStatus=d3.scale.category20(),path=svg.append("svg:g").selectAll("path").data(force.links()).enter().append("svg:path").style("stroke-width","1.5px").attr("class",function(d){return d.bd,"link"}).style("stroke",function(d){return colorStatus(getStatusRange(d.target.status))}).attr("marker-end","url(#end)"),node=svg.selectAll(".node").data(force.nodes()).enter().append("g").attr("class","node").call(force.drag),rScale=d3.scale.linear().domain([0,d3.max(eventjson.nodes,function(d){return d.e})]).range([5,25]);node.append("circle").style("fill",function(d){return colorStatus(getStatusRange(d.status))}).attr("r",function(d){return rScale(d.e)}),node.append("text").attr("x",-5).attr("y",5).attr("dy","0em").text(function(d){return d.name});node.append("title").html(function(d){return nodeInfo(d)});var statusRange=_.range(1,11),legend=svg.selectAll("legend").data(statusRange).enter().append("g");legend.append("text").attr("x",0).attr("y",0).text("Status"),legend.append("rect").attr("height",10).attr("width",10).attr("x",0).attr("y",function(d,i){return 20*i+10}).attr("fill",function(d){return colorStatus(d)}),legend.append("text").attr("x",15).attr("y",function(d,i){return 20*i+20}).html(function(d,i){return getStatusLegend(d)})}var statusList=scope.pythiastatus.statusList,statusRangeList=scope.pythiastatus.statusRangeList;d3.scale.category20();angular.element($window).bind("resize",function(){scope.$apply()});var panel=angular.element(document.querySelector("#tree")),widthPanel=panel.width(),heightPanel=.7*panel.width(),margin=scope.margin,width=widthPanel-margin.left-margin.right,height=heightPanel-margin.top-margin.bottom;scope.getWidth=function(){return panel.width()};var svg=null;scope.$watch(scope.getWidth,function(newWidth,oldWidth){if(void 0===scope.eventjson)return void console.error("undefined pythia event tree");d3.select("svg").remove(),widthPanel=newWidth,heightPanel=.7*widthPanel,width=widthPanel-margin.left-margin.right,height=heightPanel-margin.top-margin.bottom,svg=buildSVG(width,height),drawTree(svg,scope.eventjson)},!0)}return{link:link,restrict:"AE",scope:{margin:"=",eventjson:"=",pythiastatus:"="}}}),lab.directive("drawScorer",function($window,utilities){function link(scope,element,attr){function buildHistogram(scorer,graphType,layer,isValidLayer){var dataList=[],layout={};if("2D projection"===graphType||"3D projection"===graphType){if(isValidLayer){for(var nx=scope.volume.parameterisation.parameters["N copies X"].value,ny=scope.volume.parameterisation.parameters["N copies Y"].value,nTotalLayer=(scope.volume.parameterisation.parameters["N copies Z"].value,nx*ny),iMin=(layer-1)*nTotalLayer,iMax=layer*nTotalLayer-1,z=[],text=[],i=0;i<=ny;i++){var zRow=[],textRow=[];z.push(zRow),text.push(textRow)}for(var index=iMin;index<=iMax;index++){var rIndex=index-(layer-1)*nTotalLayer,row=parseInt(rIndex/nx),col=rIndex-nx*row,position=scorer.histogram.x.indexOf(index);if(position<0)z[row][col]=0,text[row][col]=z[row][col]+" &#177; 0 "+scorer.histogram.units;else{z[row][col]=scorer.histogram.y[position];var error=scorer.histogram.error_y.array[position];text[row][col]=z[row][col]+" &#177; "+error+" "+scorer.histogram.units}}var sizeUnits=scope.volume.solid.dimensions["Length X"].units,dimX=scope.volume.solid.dimensions["Length X"].value,dimY=scope.volume.solid.dimensions["Length Y"].value,sizeCellX=dimX/nx,sizeCellY=dimY/ny,data={name:scorer.data,x:_.range(0,dimX+sizeCellX,sizeCellX),y:_.range(sizeCellY/2,dimY+sizeCellY,sizeCellY),z:z,text:text,hoverinfo:"text",showscale:!0};"2D projection"===graphType&&(data.type="heatmap"),"3D projection"===graphType&&(data.type="surface"),dataList=[data];var layoutTitle=scorer.dataName.name;scorer.histogram.units.length>0&&(layoutTitle+=" ("+scorer.histogram.units+")"),layout={xaxis:{title:"X ("+sizeUnits+")",showgrid:!0},yaxis:{title:"Y ("+sizeUnits+")",range:[0,dimY],autorange:!1,showgrid:!0},showlegend:!0,title:layoutTitle}}}else{scorer.histogram.text=[],scorer.histogram.hoverinfo="text";for(var _i2=0;_i2<scorer.histogram.y.length;_i2++){var _index=scorer.histogram.x[_i2],y=scorer.histogram.y[_i2],_error=scorer.histogram.error_y.array[_i2],_text="index = "+_index+", y = "+y+" &#177; "+_error+" "+scorer.histogram.units;scorer.histogram.text.push(_text)}dataList=[scorer.histogram];var yTitle=scorer.histogram.name.name;void 0!==scorer.histogram.units&&scorer.histogram.units.length>0&&(yTitle+=" ("+scorer.histogram.units+")"),layout={xaxis:{title:"index",showgrid:!0},yaxis:{title:yTitle,showgrid:!0},showlegend:!1}}return layout.margin={l:50,r:50,b:40,t:40,pad:4},{dataList:dataList,layout:layout}}var width=90,height=100;void 0!==scope.width&&void 0!==scope.heigth&&(width=scope.width,height=scope.height);var gd=utilities.buildPlotly(element,width,height);scope.$watch("[scorer,graphtype,layer,isvalidlayer]",function(newData,oldData,scope){var scorer=newData[0],graphType=newData[1],layer=newData[2],isValidLayer=newData[3];if(void 0!==scorer&&null!=scorer){var histogram=buildHistogram(scorer,graphType,layer,isValidLayer);Plotly.newPlot(gd,histogram.dataList,histogram.layout)}},!0),window.onresize=function(){Plotly.Plots.resize(gd)}}return{link:link,restrict:"AE",scope:{scorer:"=",volume:"=",graphtype:"=",layer:"=",isvalidlayer:"=",width:"=",height:"="}}});