"use strict";lab.directive("consoleGamos",function($window,$rootScope,socket,buildMacro,buildGeom){function link(scope,element){$rootScope.termData.ptyCmd={cmd:"",argv:[]};var cmd="",initConsole=!1;if(null==$rootScope.termData.term){if($rootScope.termData.term=new Terminal({cursorBlink:!0,rows:32}),$rootScope.termData.term._initialized)return;$rootScope.termData.term._initialized=!0,$rootScope.termData.isActive=!0,$rootScope.termData.term.writePrompt=function(){$rootScope.termData.term.write("\r"+$rootScope.termData.term.prompt+" ")},$rootScope.termData.term.prompt="PreInit>",socket.emit("exp:InitConsole",null),initConsole=!0,$rootScope.termData.term.on("key",function(key,ev){var printable=!(ev.altKey||ev.altGraphKey||ev.ctrlKey||ev.metaKey||37==ev.keyCode||38==ev.keyCode||39==ev.keyCode||40==ev.keyCode);if(13==ev.keyCode){isError=!1,$rootScope.termData.term.writeln(""),cmd=cmd.replace(/  +/g," ");var cmdList=cmd.split(" ");if(""==cmdList)$rootScope.termData.term.writePrompt();else{if(_.includes(cmd,"/control/shell"))$rootScope.termData.term.writeln(""),$rootScope.termData.term.writeln("You cannot execute shell commands"),$rootScope.termData.term.writeln(""),$rootScope.termData.term.writePrompt();else if($rootScope.termData.ptyCmd={cmd:cmdList[0],argv:cmdList.splice(1)},$rootScope.termData.isActive)if("clear"===$rootScope.termData.ptyCmd.cmd)$rootScope.termData.term.reset(),$rootScope.termData.term.writePrompt();else if("exit"===$rootScope.termData.ptyCmd.cmd&&($rootScope.termData.pid=null,$rootScope.termData.isActive=!1,$rootScope.termData.term.reset(),$rootScope.termData.term.writeln(""),$rootScope.termData.term.writeln("Geant4/GAMOS session closed"),$rootScope.termData.term.writeln("Type gamos to reload the Geant4/GAMOS console."),$rootScope.termData.term.writeln(""),$rootScope.termData.term.prompt=">",$rootScope.termData.term.writePrompt()),"/control/execute"===$rootScope.termData.ptyCmd.cmd)if($rootScope.isValidAll){var macroCommands=buildMacro.buildMacroFile($rootScope.experiment),geomCommands=buildGeom.buildGeomCommands($rootScope.experiment.geometry.volumeList),commandList={macro:{fileName:$rootScope.experiment.macroFile,macroCommands:macroCommands},geom:{fileName:$rootScope.experiment.geomFile,geomCommands:geomCommands},nBeams:$rootScope.experiment.nBeams,actionList:$rootScope.experiment.data.actionList,scorerList:$rootScope.experiment.data.scorerList};$rootScope.termData.ptyCmd.expJSON=commandList,socket.emit("exp:Console",$rootScope.termData.ptyCmd)}else $rootScope.termData.term.writeln("There are errors in experiment configuration"),$rootScope.termData.term.writeln(""),$rootScope.termData.term.writePrompt();else socket.emit("exp:Console",$rootScope.termData.ptyCmd);else"gamos"===$rootScope.termData.ptyCmd.cmd&&void 0===$rootScope.termData.argv?($rootScope.termData.term.reset(),socket.emit("exp:InitConsole",null),$rootScope.termData.isActive=!0,$rootScope.termData.term.prompt="PreInit>",$rootScope.termData.term.writePrompt):($rootScope.termData.term.writeln(""),$rootScope.termData.term.writeln("Please, type gamos if you want to reload the Geant4/GAMOS console"),$rootScope.termData.term.writeln(""),$rootScope.termData.term.writePrompt());cmd=""}}else if(8==ev.keyCode){var promptLength=$rootScope.termData.term.prompt.length+1;$rootScope.termData.term.x>promptLength&&($rootScope.termData.term.write("\b \b"),cmd=cmd.substring(0,cmd.length-1))}else printable&&($rootScope.termData.term.write(key),cmd+=key)})}$rootScope.termData.term.open(element[0]),$rootScope.termData.term.fit(),socket.on("exp:ConsolePid",function(data){$rootScope.termData.pid=data});var isError=!1;socket.on("exp:ErrorConsole",function(data){isError=!0,$rootScope.termData.isActive=!1,scope.outData=data.errorData,scope.$apply()}),socket.on("exp:OutConsole",function(data){scope.outData=data,scope.$apply()}),scope.$watch("outData",function(newData,oldData){if(void 0!==newData&&null!=newData&&"exit"!=$rootScope.termData.ptyCmd.cmd){var miDataSplit=newData;if(null!=miDataSplit){miDataSplit=_.replace(miDataSplit,"\r",""),miDataSplit=miDataSplit.split("\n");var fullCmd=$rootScope.termData.ptyCmd.cmd;if(null!=$rootScope.termData.ptyCmd.argv)for(var i=0;i<$rootScope.termData.ptyCmd.argv.length;i++)fullCmd+=" "+$rootScope.termData.ptyCmd.argv[i];for(var _i=0;_i<miDataSplit.length;_i++)_.includes(miDataSplit[_i],"Idle>")&&($rootScope.termData.term.prompt="Idle>"),_.includes(miDataSplit[_i],$rootScope.termData.term.prompt)||$rootScope.termData.term.writeln(miDataSplit[_i]),_.includes(miDataSplit[_i],$rootScope.termData.term.prompt)&&(initConsole&&($rootScope.termData.term.writeln("============================================="),$rootScope.termData.term.writeln("If you want to execute the current experiment"),$rootScope.termData.term.writeln("type: /control/execute macro.in"),$rootScope.termData.term.writeln("=============================================")),$rootScope.termData.term.writePrompt(),initConsole=!1)}isError&&($rootScope.termData.term.prompt=">",$rootScope.termData.pid=null,$rootScope.termData.isActive=!1,$rootScope.termData.initTerm=!0,$rootScope.termData.term.writeln(""),$rootScope.termData.term.writeln("Geant4/GAMOS console closed"),$rootScope.termData.term.writeln("Type gamos to reload the Geant4/GAMOS console."),$rootScope.termData.term.writeln(""),$rootScope.termData.term.writePrompt())}},!0),scope.$watch("currentnode",function(newNode,oldNode){if(newNode.isCopy){var x=$rootScope.termData.term.prompt.length+1,y=$rootScope.termData.term.y;$rootScope.termData.term.eraseRight(x,y),$rootScope.termData.term.x=x,$rootScope.termData.term.write(newNode.cmd),cmd=newNode.cmd,scope.currentnode.isCopy=!1}},!0)}return{link:link,restrict:"AE",scope:{currentnode:"="}}});