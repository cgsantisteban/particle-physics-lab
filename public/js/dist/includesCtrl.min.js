"use strict";lab.controller("HeaderCtrl",function($rootScope,$scope,socket,ExperimentListService,initExperiment,FileSaver,Blob,$location,$uibModal){$scope.saveExperiment=function(size,_id,type){if(type<0){delete $rootScope.experiment._id;var date=Date.now();$rootScope.experiment.date=date;$uibModal.open({animation:!0,templateUrl:"views/main/saveExperiment.html",controller:"SaveExperimentCtrl",size:size,resolve:{id:function(){return _id}}}).result.then(function(exp){$rootScope.isSaved=!0},function(cancel){})}else if(void 0===_id){var _modalSave=$uibModal.open({animation:!0,templateUrl:"views/main/saveExperiment.html",controller:"SaveExperimentCtrl",size:size,resolve:{id:function(){return _id}}});_modalSave.result.then(function(exp){$rootScope.isSaved=!0},function(cancel){})}else{var _date=Date.now();$rootScope.experiment.date=_date,$rootScope.isSaved=!0,ExperimentListService.saveExperiment($rootScope.experiment).then(function(data){$rootScope.experiment=data.data.experiment,$rootScope.experimentList=data.data.experimentList},function(error){console.log("Error: ",error)})}},$scope.isSavedF=function(experiment){return void 0!==experiment._id},$scope.resetExperiment=function(size){$uibModal.open({animation:!0,backdrop:!1,templateUrl:"views/main/newExperiment.html",controller:"NewExperimentCtrl",size:size}).result.then(function(isOk){if(isOk){socket.emit("newExperiment",{}),$rootScope.experiment=initExperiment.getExperiment();var histograms=initExperiment.getHistograms();$rootScope.histograms=angular.copy(histograms);var initValues=angular.copy(initExperiment.initGlobal());$rootScope.isValidAll=initValues.isValidAll,$rootScope.isValidExperiment=initValues.isValidExperiment,$rootScope.isSaved=initValues.isSaved,$rootScope.showSummary=initValues.showSummary,$rootScope.okRunExperiment=initValues.okRunExperiment,$rootScope.maxEvent=initValues.maxEvent,$rootScope.maxLength=initValues.maxLength,$rootScope.termData=initValues.termData,$location.path("#/particlelab")}},function(cancel){})},$scope.importExperiment=function(size){$uibModal.open({animation:!0,backdrop:!1,templateUrl:"views/main/importExperiment.html",controller:"ImportExperimentCtrl",size:size}).result.then(function(exp){socket.emit("newExperiment",{}),$rootScope.experiment=exp;var histograms=initExperiment.getHistograms();$rootScope.histograms=angular.copy(histograms);var initValues=angular.copy(initExperiment.initGlobal());$rootScope.isValidAll=initValues.isValidAll,$rootScope.isValidExperiment=initValues.isValidExperiment,$rootScope.isSaved=!1,$rootScope.okRunExperiment=!1,$rootScope.showSummary=!1,$location.path("#!/particlelab")},function(cancel){})},$scope.exportExperiment=function(){if($rootScope.isValidAll){var experiment=angular.copy($rootScope.experiment);void 0!==experiment._id&&delete experiment._id,void 0!==experiment.__v&&delete experiment.__v;var data=new Blob([JSON.stringify(experiment,null,2)],{type:"text/plain;charset=utf-8"});FileSaver.saveAs(data,"experiment.json")}}}),lab.controller("LeftNavCtrl",function($rootScope,$scope,$location,pageListService){$scope.pageList=pageListService.getPageList(),$scope.$watch("isValidExperiment",function(newIsValidExperiment,oldIsValidExperiment){var isValidLabHome=newIsValidExperiment.isValidEMField&&newIsValidExperiment.isValidLocalField&&newIsValidExperiment.isValidBeams;$scope.pageList.Main["Lab Home"].isValid=isValidLabHome;var isValidGeometry=newIsValidExperiment.isValidPythiaProcess&&newIsValidExperiment.isValidPythiaBeam&&newIsValidExperiment.isValidVolumes;$scope.pageList.Main.Geometry.isValid=isValidGeometry,$scope.pageList.Main.Sources.isValid=newIsValidExperiment.isValidSources;var isValidData=newIsValidExperiment.isValidActions&&newIsValidExperiment.isValidScorers&&newIsValidExperiment.isValidFilters;$scope.pageList.Main.Analysis.isValid=isValidData},!0),$scope.getToolTipError=function(pageName,isValidExperiment){var msg="There are errors in: ";return"Lab Home"===pageName&&(isValidExperiment.isValidEMField||(msg+="Uniform EM fields "),isValidExperiment.isValidLocalField||(msg+="Local magenic field "),isValidExperiment.isValidBeams||(msg+="Number of beams.")),"Geometry"===pageName&&(isValidExperiment.isValidVolumes||(msg+="volume "),$rootScope.experiment.isPythia?(isValidExperiment.isValidPythiaBeam||(msg+="Pythia beam definition "),isValidExperiment.isValidPythiaProcess||(msg+="Pythia processes ")):isValidExperiment.isValidSources||(msg+="source ")),"Analysis"===pageName&&(isValidExperiment.isValidActions||(msg+="GAMOS data definition")),msg},$scope.$watch("histograms",function(newHisto,oldHisto){var isEmptyHistograms=_.isEmpty(newHisto),isEmptySummary=!1,isEmptyActionHisto=!1,isEmptyScorerHisto=!1,isEmptyPythiaTree=!1,isEmptyPythiaHistogram=!1;isEmptyHistograms||(isEmptySummary=_.isEmpty(newHisto.summary.partCount)||_.isEmpty(newHisto.summary.procCount)||_.isEmpty(newHisto.summary.procCreator),isEmptyActionHisto=_.isEmpty(newHisto.actionHistograms),isEmptyScorerHisto=_.isEmpty(newHisto.scorerHistograms),isEmptyPythiaTree=_.isEmpty(newHisto.pythiaTree),isEmptyPythiaHistogram=_.isEmpty(newHisto.pythiaHistograms)),$rootScope.isVisibleSummary=!isEmptySummary,$rootScope.isVisiblePythiaTree=!isEmptyPythiaTree,$rootScope.isVisiblePythiaHistogram=!isEmptyPythiaHistogram,$rootScope.isVisibleActionHisto=!isEmptyActionHisto,$rootScope.isVisibleScorerHisto=!isEmptyScorerHisto,$scope.pageList.Histograms.Summary.isVisible=!isEmptySummary,$scope.pageList.Histograms["GAMOS Data"].isVisible=!isEmptyActionHisto,$scope.pageList.Histograms.Scorers.isVisible=!isEmptyScorerHisto,$scope.pageList.Histograms["Pythia tree"].isVisible=!isEmptyPythiaTree,$scope.pageList.Histograms["Pythia data"].isVisible=!isEmptyPythiaHistogram,$scope.isVisibleTitle=!(isEmptySummary&&isEmptyActionHisto&&isEmptyScorerHisto&&isEmptyPythiaTree&&isEmptyPythiaHistogram)},!0),$scope.$watch(function(){return $location.path()},function(newUrl,oldUrl){for(var p in $scope.pageList.Main){var url=$scope.pageList.Main[p].url;$scope.pageList.Main[p].isActive=url===newUrl}for(var _p in $scope.pageList.Histograms){var _url=$scope.pageList.Histograms[_p].url;$scope.pageList.Histograms[_p].isActive=_url===newUrl}},!0)});